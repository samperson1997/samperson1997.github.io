<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta name="description" content="Blog of Samperson">
  <meta name="keyword" content="">
  
    <link rel="shortcut icon" href="/css/images/logo.png">
  
  <title>
    
      ⛵️帆船书#16 | 恢复系统 | Blog of Samperson
    
  </title>
  <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="//cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.css" rel="stylesheet">
  <link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/tomorrow.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/geopattern/1.2.3/js/geopattern.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.js"></script>
  
  
  
  
    <!-- MathJax support START -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <!-- MathJax support END -->
  


</head>
<div class="wechat-share">
  <img src="/css/images/logo.png" />
</div>

  <body>
    <header class="header fixed-header">
  <div class="header-container">
    <a class="home-link" href="/">
      <div class="logo"></div>
      <span>Blog of Samperson</span>
    </a>
    <ul class="right-list">
      
        <li class="list-item">
          
            <a href="/" class="item-link">Home</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/tags/" class="item-link">Tags</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/archives/" class="item-link">Archives</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/project/" class="item-link">Projects</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/about/" class="item-link">About</a>
          
        </li>
      
    </ul>
    <div class="menu">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </div>
    <div class="menu-mask">
      <ul class="menu-list">
        
          <li class="menu-item">
            
              <a href="/" class="menu-link">Home</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/tags/" class="menu-link">Tags</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/archives/" class="menu-link">Archives</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/project/" class="menu-link">Projects</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/about/" class="menu-link">About</a>
            
          </li>
        
      </ul>
    </div>
  </div>
</header>

    <div id="article-banner">
  <h2>⛵️帆船书#16 | 恢复系统</h2>
  <p class="post-date">2020-02-07</p>
  <div class="arrow-down">
    <a href="javascript:;"></a>
  </div>
</div>
<main class="app-body flex-box">
  <!-- Article START -->
  <article class="post-article">
    <section class="markdown-content"><h2 id="故障分类和存储器"><a href="#故障分类和存储器" class="headerlink" title="故障分类和存储器"></a>故障分类和存储器</h2><p>[1] 故障分类</p>
<ol>
<li>事务故障: 逻辑错误(内部条件, 非法输入、找不到数据、溢出、超出资源限制); 系统错误(死锁等导致事务无法继续执行)</li>
<li>系统崩溃: 硬件故障或数据库软件呢、操作系统漏洞, 导致易失性存储器内容丢失, 但是非易失性存储器完好无损</li>
<li>磁盘故障: (破坏非易失性存储器内容), 可以从三级介质的归档备份恢复</li>
</ol>
<p>[2] 存储结构</p>
<ul>
<li>易失性存储器(主存, cache): 计算机崩溃时丢失</li>
<li>非易失性存储器(磁盘, 闪存, 光盘, 磁带): 磁盘崩溃时丢失</li>
<li>稳定性存储器: 永不丢失, 可以复制非易失性存储器介质并采用<strong>独立故障模式</strong></li>
</ul>
<p>[3] 稳定存储器<br><strong>必须支持在线访问</strong>的稳定存储器与<strong>磁盘镜像</strong>或者其他形式的提供冗余数据存储的<strong>RAID</strong>接近<br>对于<strong>离线或归档</strong>的情况, 稳定性存储器可以由存储在物理安全位置的数据的<strong>多个磁盘备份</strong>构成</p>
<h3 id="数据访问"><a href="#数据访问" class="headerlink" title="数据访问"></a>数据访问</h3><p>[1] 磁盘中的某些错误可以由存储在每个块中的校验和检测<br>恢复过程中比较每一对相应块开销太大——解决方案: 使用少量非易失性RAM, 跟踪正在进行的对应块的写操作; 恢复时只比较正在写的块</p>
<p>[2] 物理块: 磁盘上的块; 缓冲快: 临时位于主存的块</p>
<p>[3] <strong>input</strong>: 物理块B到主存<br>事务T的私有工作区用于保存T当问及更新的所有数据项X的拷贝, 在事务初始化时由系统创建, 事务提交或中止时由系统删除<br>T通过在其工作区和系统缓冲区之间传送数据, 与数据库系统交互</p>
<ol>
<li>read将X值赋给局部变量x, 如果X所在块B不在主存中, 需要input(B)</li>
<li>write将局部变量x值赋给缓冲区块中数据项X, 如果X所在块B不再驻村中, 需要input(B)</li>
</ol>
<p>[4] <strong>output</strong>: 缓冲块B到磁盘, 替换磁盘相应物理块<br>强制输出: 缓冲区管理器需要内存空间; 数据库系统希望将B的变化反映到磁盘<br>output(B)不需要在write后立即执行, 因为B可能包含其他仍在被访问的数据项</p>
<h2 id="恢复与原子性"><a href="#恢复与原子性" class="headerlink" title="恢复与原子性"></a>恢复与原子性</h2><p>[1] <strong>更新日志记录</strong>有如下字段: 事务标识、数据项标识(数据项在磁盘位置, 数据项驻留块的块标识和块内偏移量)、旧值、新值</p>
<p>[2] 事务修改数据项的步骤</p>
<ol>
<li>事务在主存中自己私有的部分执行某些计算</li>
<li>事务修改主存磁盘缓冲区中包含该数据项的数据块</li>
<li>系统执行output操作后数据库块写到磁盘中</li>
</ol>
<p>[3] <strong>延迟修改</strong>: 事务直到提交都没有修改数据库, 事务执行的所有write延迟到事务提交时执行<br>开销: 事务需要创建(更新过的所有数据项的)本地拷贝; 如果一个事务读他更新过的数据项, 必须从本地拷贝中读<br>日志记录<strong>不需要包含已更新的数据项的旧值</strong></p>
<p><strong>立即修改</strong>: 数据库修改在事务仍然活跃时发生</p>
<p>[4] 事务回滚: 从后往前扫描日志<br>利用旧值字段可以<strong>撤销</strong>已经输出到数据库中的修改, 作为撤销的一部分, 要使用<strong>redo-only日志</strong>要记录执行的更新(redo-only日志不包含更新的数据项的旧值)<br><strong>undo操作之后需要写一个abort日志记录</strong></p>
<p>[5] 系统发生崩溃之后:</p>
<ol>
<li>重做阶段: <strong>正向</strong>扫描日志重放<strong>所有</strong>事务的更新, 如果日志包括 [start] 以及 [commit或者abort], 需要redo (abort: 如果日志包括abort, 意味着有redo-only日志, 需要对T的修改进行撤销) redo将将T更新过的数据项的值设置成新值<ul>
<li>如果找到redo-only或者正常日志记录, 则redo这个操作</li>
<li>如果遇到start, 把T加入undo-list</li>
<li>如果遇到abort或者commit, 把T从undo-list中去掉 </li>
</ul>
</li>
<li>撤销阶段: <strong>反向</strong>扫描日志进行回滚<br>如果日志包括start记录, 但不包括commit或abort, 需要undo<ul>
<li>遇到undo-list中的事务记, 则undo, 并向日志中写redo-only记录</li>
<li>如果遇到start, 往日志中写一个abort, 并把T从undo-list中去掉</li>
<li>undo-list变为空表, 撤销阶段结束</li>
</ul>
</li>
</ol>
<h3 id="检查点"><a href="#检查点" class="headerlink" title="检查点"></a>检查点</h3><p>[1] 检查点</p>
<ol>
<li>当前位于主存的所有日志记录输出到<strong>稳定存储器</strong></li>
<li>所有修改的缓冲块输出到磁盘</li>
<li>将一个日志记录checkpoint L输出到<strong>稳定存储器</strong>, L为检查点时正活跃的事务列表</li>
</ol>
<p>[2] 模糊检查点: 允许检查点记录写入日志后, 修改过的缓冲块写到磁盘前开始做更新<br>如果系统在所有页面写完前崩溃, 磁盘上的检查点可能不完全——解决方案: 将最后一个完全检查点记录在<strong>磁盘上的固定位置last_checkpoint</strong>, 写入checkpoint时不更新该信息, 在写checkpoint记录前创建所有修改过的缓冲区块的列表, 只有在该列表中的所有缓冲块都输出到磁盘上以后, last_checkpoint信息才更新</p>
<h2 id="缓冲区管理"><a href="#缓冲区管理" class="headerlink" title="缓冲区管理"></a>缓冲区管理</h2><p>[1] 日志缓冲区</p>
<ol>
<li>日志记录commit输出到稳定存储器后, 事务进入提交状态</li>
<li>日志记录commit输出到稳定存储器前, 事务有关的所有日志记录必须输出到稳定存储器</li>
<li>主存中的数据块输出到数据库前, 所有鱼数据块中数据有关日志记录必须输出到稳定存储器</li>
</ol>
<p>[2] 写前日志WAL: undo信息已经输出到稳定存储器中, 而redo信息允许以后再写</p>
<p>[3] 数据库缓冲</p>
<table>
<thead>
<tr>
<th style="text-align:left"></th>
<th style="text-align:left"></th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><strong>强制</strong>: 事务提交时所有修改过块输出到磁盘</td>
<td style="text-align:left"><strong>非强制</strong>(采用): 即使一个事务修改了还没写回到磁盘的块, 也允许提交</td>
<td style="text-align:left">非强制策略可以更快提交;<br>将多个更新聚集在一起, 见效频繁更新的块输出操作的数目</td>
</tr>
<tr>
<td style="text-align:left"><strong>非窃取</strong>: 仍然活跃的事务修改过的块不写出到磁盘</td>
<td style="text-align:left"><strong>窃取</strong>(采用): 即使修改的事务还没提交, 也允许将修改过的块写到磁盘</td>
<td style="text-align:left">非窃取策略不适合执行大量更新的事务, 因为缓冲区可能被一更新过但不能逐出到磁盘的页面占满</td>
</tr>
</tbody>
</table>
<p>[4] <strong>闩锁</strong>封锁方法(非两阶段)<br>当一个块要输出时:</p>
<ol>
<li>获取排他锁, 确保没有任何事物正在进行写操作</li>
<li>日志记录输出到稳定存储器</li>
<li>块输出到磁盘</li>
<li>块输出完成后, 释放排他锁</li>
</ol>
<p>保证检查点进行过程中缓冲块不更新, 而且没有新的日志记录产生</p>
<ol>
<li>要求在检查点操作开始之前必须获得所有缓冲块的排他锁以及对日志的排他锁</li>
<li>检查点操作完成后释放锁</li>
</ol>
<p>[5] 不断在缓冲块间循环, 将修改过的缓冲块输出到磁盘。好处:<br>缓冲区中的脏块数目减少, 检查点过程中需要输出的块数目减少<br>需要从缓冲区逐出一个块时, 不脏的块可以逐出, 输入马上可以进行, 不必等待输出完成</p>
<p>[6] 管理数据库缓冲区</p>
<ul>
<li>数据库系统保留部分主存作为缓冲区, 不让操作系统管理——缺点: 限制主存使用灵活性, 所有应用都不能利用所有可用内存</li>
<li>操作系统的虚拟内存中实现缓冲区, 让操作系统决定哪个缓冲块在什么时候强制输出到磁盘——缺点: 应该由数据库系统强制输出缓冲块, 否则会导致额外的数据到磁盘的输出</li>
</ul>
<p>[7] 主存储器中包括: 日志缓冲区、数据库缓冲区、系统缓冲区<br>系统缓冲区由系统目标码页面和事务的局部工作区域</p>
<h2 id="非易失性存储器数据丢失的故障"><a href="#非易失性存储器数据丢失的故障" class="headerlink" title="非易失性存储器数据丢失的故障"></a>非易失性存储器数据丢失的故障</h2><p>[1] 归档转储: 周期性将数据库内容转储到稳定存储器, 要求不能有事务处于活跃状态<br>恢复时可以利用最近一次转储将数据库复原到磁盘, 然后根据日志, 重做最近一次转储后所做的动作, <strong>不必执行任何undo操作</strong></p>
<p>[2] SQL转储: 将SQL的DDL和insert语句写到文件中, 可以重执行来重新创建数据库<br>用于将数据库已知道数据库另一个实例或数据库软件另一个版本, 因为物理位置或布局可能不同</p>
<h2 id="锁的提前释放和逻辑undo操作"><a href="#锁的提前释放和逻辑undo操作" class="headerlink" title="锁的提前释放和逻辑undo操作"></a>锁的提前释放和逻辑undo操作</h2><p>恢复技术支持高并发封锁技术: 用于B+树并发控制的封锁技术, 允许提前释放通过插入或删除操作获得的<strong>低级别的锁</strong>(允许别的事务其他的这类操作可以执行)<br>低级别的锁被释放后, 不能进行物理undo, 进行逻辑undo(如: 用删除对插入做undo)<br>事务保持<strong>高级别的锁</strong>确保并发的事务不会执行这样的动作, 可能导致一个操作的逻辑undo不可能</p>
<h2 id="ARIES"><a href="#ARIES" class="headerlink" title="ARIES"></a>ARIES</h2><p>提供更大并发性, 削减日志开销, 最小化恢复时间<br>基于历史, 允许逻辑undo操作<br>不断清洗页, 从而不需要在检查点清洗所有页<br>使用日志顺序号(LSN)减少恢复所花时间</p>
<h2 id="远程备份系统"><a href="#远程备份系统" class="headerlink" title="远程备份系统"></a>远程备份系统</h2><p>主站点发生故障, 远程站点执行一定恢复动作, 然后接管事务处理</p>
</section>
    <!-- Tags START -->
    
      <div class="tags">
        <span>Tags:</span>
        
  <a href="/tags#数据库系统概念" >
    <span class="tag-code">数据库系统概念</span>
  </a>

      </div>
    
    <!-- Tags END -->
    <!-- NAV START -->
    
  <div class="nav-container">
    <!-- reverse left and right to put prev and next in a more logic postition -->
    
      <a class="nav-left" href="/2020/02/02/dbsc13/">
        <span class="nav-arrow">← </span>
        
          ⛵️帆船书#13 | 查询优化
        
      </a>
    
    
      <a class="nav-right" href="/2020/02/09/dbsc19/">
        
          dbsc19
        
        <span class="nav-arrow"> →</span>
      </a>
    
  </div>

    <!-- NAV END -->
  </article>
  <!-- Article END -->
  <!-- Catalog START -->
  
    <aside class="catalog-container">
  <div class="toc-main">
    <strong class="toc-title">Catalog</strong>
    
      <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#故障分类和存储器"><span class="toc-nav-number">1.</span> <span class="toc-nav-text"><a href="#&#x6545;&#x969C;&#x5206;&#x7C7B;&#x548C;&#x5B58;&#x50A8;&#x5668;" class="headerlink" title="&#x6545;&#x969C;&#x5206;&#x7C7B;&#x548C;&#x5B58;&#x50A8;&#x5668;"></a>&#x6545;&#x969C;&#x5206;&#x7C7B;&#x548C;&#x5B58;&#x50A8;&#x5668;</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#数据访问"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text"><a href="#&#x6570;&#x636E;&#x8BBF;&#x95EE;" class="headerlink" title="&#x6570;&#x636E;&#x8BBF;&#x95EE;"></a>&#x6570;&#x636E;&#x8BBF;&#x95EE;</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#恢复与原子性"><span class="toc-nav-number">2.</span> <span class="toc-nav-text"><a href="#&#x6062;&#x590D;&#x4E0E;&#x539F;&#x5B50;&#x6027;" class="headerlink" title="&#x6062;&#x590D;&#x4E0E;&#x539F;&#x5B50;&#x6027;"></a>&#x6062;&#x590D;&#x4E0E;&#x539F;&#x5B50;&#x6027;</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#检查点"><span class="toc-nav-number">2.1.</span> <span class="toc-nav-text"><a href="#&#x68C0;&#x67E5;&#x70B9;" class="headerlink" title="&#x68C0;&#x67E5;&#x70B9;"></a>&#x68C0;&#x67E5;&#x70B9;</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#缓冲区管理"><span class="toc-nav-number">3.</span> <span class="toc-nav-text"><a href="#&#x7F13;&#x51B2;&#x533A;&#x7BA1;&#x7406;" class="headerlink" title="&#x7F13;&#x51B2;&#x533A;&#x7BA1;&#x7406;"></a>&#x7F13;&#x51B2;&#x533A;&#x7BA1;&#x7406;</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#非易失性存储器数据丢失的故障"><span class="toc-nav-number">4.</span> <span class="toc-nav-text"><a href="#&#x975E;&#x6613;&#x5931;&#x6027;&#x5B58;&#x50A8;&#x5668;&#x6570;&#x636E;&#x4E22;&#x5931;&#x7684;&#x6545;&#x969C;" class="headerlink" title="&#x975E;&#x6613;&#x5931;&#x6027;&#x5B58;&#x50A8;&#x5668;&#x6570;&#x636E;&#x4E22;&#x5931;&#x7684;&#x6545;&#x969C;"></a>&#x975E;&#x6613;&#x5931;&#x6027;&#x5B58;&#x50A8;&#x5668;&#x6570;&#x636E;&#x4E22;&#x5931;&#x7684;&#x6545;&#x969C;</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#锁的提前释放和逻辑undo操作"><span class="toc-nav-number">5.</span> <span class="toc-nav-text"><a href="#&#x9501;&#x7684;&#x63D0;&#x524D;&#x91CA;&#x653E;&#x548C;&#x903B;&#x8F91;undo&#x64CD;&#x4F5C;" class="headerlink" title="&#x9501;&#x7684;&#x63D0;&#x524D;&#x91CA;&#x653E;&#x548C;&#x903B;&#x8F91;undo&#x64CD;&#x4F5C;"></a>&#x9501;&#x7684;&#x63D0;&#x524D;&#x91CA;&#x653E;&#x548C;&#x903B;&#x8F91;undo&#x64CD;&#x4F5C;</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#ARIES"><span class="toc-nav-number">6.</span> <span class="toc-nav-text"><a href="#ARIES" class="headerlink" title="ARIES"></a>ARIES</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#远程备份系统"><span class="toc-nav-number">7.</span> <span class="toc-nav-text"><a href="#&#x8FDC;&#x7A0B;&#x5907;&#x4EFD;&#x7CFB;&#x7EDF;" class="headerlink" title="&#x8FDC;&#x7A0B;&#x5907;&#x4EFD;&#x7CFB;&#x7EDF;"></a>&#x8FDC;&#x7A0B;&#x5907;&#x4EFD;&#x7CFB;&#x7EDF;</span></a></li></ol>
    
  </div>
</aside>
  
  <!-- Catalog END -->
</main>

<script>
    (function() {
        var url = 'http://yoursite.com/2020/02/07/dbsc16/';
        var banner = 'https://images.pexels.com/photos/2470678/pexels-photo-2470678.jpeg?h=1280&w=1921'
        if (banner !== '' && banner !== 'undefined' && banner !== 'null') {
            $('#article-banner').css({
                'background-image': 'url(' + banner + ')'
            })
        } else {
            $('#article-banner').geopattern(url)
        }
        $('.header').removeClass('fixed-header')

        // error image
        $(".markdown-content img").on('error', function() {
            $(this).attr('src', 'http://file.muyutech.com/error-img.png')
            $(this).css({
                'cursor': 'default'
            })
        })

    // zoom image
    $(".markdown-content img").on('click', function() {
      var src = $(this).attr('src')
      if (src !== 'http://file.muyutech.com/error-img.png') {
        var imageW = $(this).width()
        var imageH = $(this).height()

        var zoom = ($(window).width() * 0.95 / imageW).toFixed(2)
        zoom = zoom < 1 ? 1 : zoom
        zoom = zoom > 2 ? 2 : zoom
        var transY = (($(window).height() - imageH) / 2).toFixed(2)

        $('body').append('<div class="image-view-wrap"><div class="image-view-inner"><img src="'+ src +'" /></div></div>')
        $('.image-view-wrap').addClass('wrap-active')
        $('.image-view-wrap img').css({
          'width': `${imageW}`,
          'transform': `translate3d(0, ${transY}px, 0) scale3d(${zoom}, ${zoom}, 1)`
        })
        $('html').css('overflow', 'hidden')

        $('.image-view-wrap').on('click', function() {
          $(this).remove()
          $('html').attr('style', '')
        })
      }
    })
  })();
</script>







    <div class="scroll-top">
  <span class="arrow-icon"></span>
</div>
    <footer class="app-footer">
  <p class="copyright">
    &copy; 2017-2020 | Content by <a href="https://samperson1997.github.io/about/">Samperson</a> | Proudly powered by <a href="https://hexo.io" target="_blank">Hexo</a>
    | Theme by <a href="https://github.com/yanm1ng">yanm1ng</a>
  </p>
</footer>

<script>
  function async(u, c) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }
</script>
<script>
  async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
    FastClick.attach(document.body);
  })
</script>

<script>
  var hasLine = 'true';
  async("//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js", function(){
    $('figure pre').each(function(i, block) {
      var figure = $(this).parents('figure');
      if (hasLine === 'false') {
        figure.find('.gutter').hide();
      }
      var lang = figure.attr('class').split(' ')[1] || 'code';
      var codeHtml = $(this).html();
      var codeTag = document.createElement('code');
      codeTag.className = lang;
      codeTag.innerHTML = codeHtml;
      $(this).attr('class', '').empty().html(codeTag);
      figure.attr('data-lang', lang.toUpperCase());
      hljs.highlightBlock(block);
    });
  })
</script>
<!-- Baidu Tongji -->

<script src="/js/script.js"></script>
  </body>
</html>